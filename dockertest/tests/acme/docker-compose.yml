services:
  # The web server to test
  ferron:
    networks:
      default:
        aliases:
          - ferron-http01
          - ferron-ondemand
          - ferron-http01-ondemand
    build:
      context: ../../..
      dockerfile: Dockerfile.test
    volumes:
      - ./ferron.kdl:/etc/ferron.kdl
      - ./cache:/var/cache/ferron-acme
    depends_on:
      ferron-acme-change-vol-ownership:
        condition: service_completed_successfully
      pebble-health-check:
        condition: service_healthy

  # The ACME server for testing
  pebble:
    image: ghcr.io/letsencrypt/pebble:latest
    command: -config /etc/pebble-config.json
    volumes:
      - ./pebble-config.json:/etc/pebble-config.json
    #ports:
    #  - 14000:14000 # HTTPS ACME API
    #  - 15000:15000 # HTTPS Management API

  # The Pebble health check container
  pebble-health-check:
    image: alpine
    command: "tail -f /dev/null"
    healthcheck:
      test: "wget --no-check-certificate -q -O /dev/null https://pebble:14000/dir"
      interval: 3s
      timeout: 5s
      retries: 3

  # Container to change ownership of the volume, necessary for the ACME cache to work properly
  ferron-acme-change-vol-ownership:
    image: alpine
    user: "root"
    volumes:
      - ./cache:/tmp/change-ownership
    command: chown nobody:nogroup /tmp/change-ownership

  # A container to run tests
  test-runner:
    build:
      context: ../../runner
    command: "tail -f /dev/null"
